<!doctype html>
<html lang="en">
	<head>
		<title>Bitcoin Proof-of-Life</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta name="theme-color" content="#1C1C1E">
		<meta name="description" content="Bitcoin Proof-of-Life">
		<meta name="keywords" content="bitcoin, proof, of, life" />
		<link rel="icon" type="image/png" href="assets/img/icon/favicon.png" sizes="32x32">
		<link rel="apple-touch-icon" sizes="180x180" href="assets/img/icon/192x192.png">
		<link rel="manifest" href="__manifest.json">

		<!-- The page supports only a dark color schemes -->
		<meta name="color-scheme" content="dark">

		<!-- Bootstrap CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
    
		<!-- iOS splash screen -->
		<link href="assets/img/splashscreens/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />
		<link href="assets/img/splashscreens/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" rel="apple-touch-startup-image" />

		<!-- Twitter card -->				
		<meta name="twitter:card" content="summary" />
		<meta name="twitter:site" content="@PoW_chain" />
		<meta name="twitter:title" content="Bitcoin Proof-of-Life" />
		<meta name="twitter:description" content="Proof of life based on the Bitcoin timechain." />
		<meta name="twitter:image" content="https://blockslide.org/bitcoin-proof-of-life/assets/img/icon/512x512.png" />

		<!-- Google Fonts -->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat">

		<!-- Pull to refresh -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/PullToRefresh/0.1.1/ptr.min.css" integrity="sha384-3jcnvfHpukZfV2vL6Ddo1Vv+JLki3kTt5HgnhOh0yB76jU3EEOj7Y6lOGNiBebOE" crossorigin="anonymous">

		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-TWSY0PCWCQ"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-TWSY0PCWCQ');
		</script>
		
		<style>
			.qr-code {
				display: block;
				height: 350px;
				opacity: 0;
			}
			
			.qr-code img {
				margin: 0 auto;
			}

			.ptr--text, .ptr--icon {
				color: rgba(255, 255, 255, 0.8) !important;
			}

			h1, h4, h5 {
				font-family: "Montserrat", sans-serif;
                font-weight: bold;
			}

            body, td {
                font-family: "Open Sans", sans-serif;
                font-size: 1rem;
            }

			th {
                font-family: "Open Sans", sans-serif;
                font-size: 0.9rem;
			}
		</style>
	</head>
	
	<body>
		<div class="container pt-5 pb-5">
			<div class="row">
				<div class="col-md-8 mx-auto text-center">
					<h1 class="display-4 p-4 text-white">Proof-of-Life</h1>

					<div class="qr-code" id="qr-code-container"></div>
					
					<h5 class="pt-4 text-warning" id="status">Not connected</h5>

					<button id="reload" type="button" class="btn btn-warning mb-4" onClick="init()" style="display: none">Reload</button>

					<table class="table">
						<tbody>
						<tr>
							<th scope="row">Latest hash</th>
							<td id="status-hash" class="text-break align-middle">...</td>
						</tr>
						<tr>
							<th scope="row">Block height</th>
							<td id="status-height" class="align-middle">...</td>
						</tr>
						<tr>
							<th scope="row">Block date and time</th>
							<td id="status-time" class="align-middle">...</td>
						</tr>
						<tr>
							<th scope="row">Local date and time</th>
							<td id="status-current" class="align-middle">...</td>
						</tr>
						</tbody>
					</table>
 
					<h4 class="pt-4 pb-2 text-white">Explanation</h4>
					<p class="pb-2">Approximately every 10 minutes a new block is generated and added to the Bitcoin timechain. The hash of the new block is nearly impossible to predict and very easy to verify after the fact. Take a photo with the image above to prove that you were alive at this given block height. The date and time that the block was generated is given, but must be considered an estimate.</p>
 
					<h4 class="pt-4 pb-2 text-white">If you like this...</h4>
					<div>
						<a class="donate-with-crypto"
						   href="https://commerce.coinbase.com/checkout/6608e3da-2914-4924-8d11-542996ffe8e8">
						  Donate with Crypto
						</a>
						<script src="https://commerce.coinbase.com/v1/checkout.js?version=201807">
						</script>
					</div>
				</div>
			</div>
		</div>
				
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/luxon@2.3.0/build/global/luxon.min.js" integrity="sha384-9CMzFL3va/6KyW0gzQBtAa1e7q2PlrLY8f/InPPaxJrruBv86zU8N1hjkFyDZCT7" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.4.10/dist/easy.qrcode.min.js" integrity="sha384-uK3A4gMHfs8FR5H7cC3k4sLXIe4LOJbOxSNHPDYVbl1mrsmdHS+VNdqoa7FLhYJN" crossorigin="anonymous"></script>	
        	<script src="https://cdnjs.cloudflare.com/ajax/libs/pulltorefreshjs/0.1.19/index.umd.min.js" integrity="sha384-+aCklUXLgjc0FJDml0+dCZHX6bf8Ltj9wPL1rDhyA5LQxpf20l1F1txX+s0Q6gOV" crossorigin="anonymous"></script>

		<script>
			var websocket;

			function start() {
				websocket.send('{"op":"ping_block"}');
                		websocket.send('{"op":"blocks_sub"}');
			}

			function stop() {
				websocket.send('{"op":"blocks_unsub"}');
			}

			function fadeIn(fade) {
				var opacity = 0;
				var intervalID = setInterval(function() {
					if (opacity < 1) {
						opacity = opacity + 0.1
						fade.style.opacity = opacity;
					} else {
						clearInterval(intervalID);
					}
				}, 100);
			}

			// https://stackoverflow.com/a/59339394
			function hexToBase64(hexStr) {
				let base64 = "";
				for(let i = 0; i < hexStr.length; i++) {
					base64 += !(i - 1 & 1) ? String.fromCharCode(parseInt(hexStr.substring(i - 1, i + 1), 16)) : "";
				}
				return btoa(base64);
			}

			function init() { 
				let DateTime = luxon.DateTime;
				let statusElement = document.getElementById("status");
				let reloadElement = document.getElementById("reload");
				
				websocket = new WebSocket("wss://ws.blockchain.info/inv"); //https://www.blockchain.com/api/api_websocket
				
				websocket.onopen = function() { 
					statusElement.innerHTML = "Connected";
					statusElement.classList.remove("text-warning");
					statusElement.classList.add("text-success");
					reloadElement.style.display = "none";

					start();
				};

				websocket.onclose = function (event) {
					statusElement.classList.remove("text-success");
					statusElement.classList.add("text-warning");
					reloadElement.style.display = "inline";
					statusElement.innerHTML = "Connection closed, trying to reconnect..."; //" (" + event.code + ")"; 

					setTimeout(function () { init(); }, 2000);
				};

				websocket.onmessage = function(event) { 
					//message processing code goes here
					var msgData = JSON.parse(event.data);

					if (msgData.op == "block") {

						var blockHash = msgData.x.hash;
						var blockHeight = msgData.x.height;
						var blockTime = msgData.x.time;
						let QRCodeContainer = document.getElementById("qr-code-container");
						let QRText = "https://www.blockchain.com/btc/block/" + blockHash; // hexToBase64(blockHash)
						
						// empty the container
						QRCodeContainer.innerHTML = "";

						fadeIn(QRCodeContainer);

						// Options
						var options = {
							text: QRText,
							width: 350,
							height: 350,
							colorDark: "#fff",
							colorLight: "#1C1C1E",
							correctLevel : QRCode.CorrectLevel.M,
							logo: "https://blockslide.org/bitcoin-proof-of-life/assets/img/bitcoin-logo.png", 
							logoWidth: 99,
							logoHeight: 99,
							logoBackgroundColor: '#1C1C1E',
							drawer: 'svg'
						};

						// Create QRCode Object
						new QRCode(QRCodeContainer, options);

						console.log("New block received: " + blockHash + " (hex), " + hexToBase64(blockHash) + " (base64)");

						document.getElementById("status-hash").innerHTML = blockHash;
						document.getElementById("status-height").innerHTML = blockHeight;
						document.getElementById("status-time").innerHTML = DateTime.fromSeconds(blockTime, { zone: 'utc' }).toFormat('FFF');
					}
				};

				// Display current date and time		
				setInterval(function () { document.getElementById("status-current").innerHTML = DateTime.utc().toFormat('FFF') }, 1000);

				// Ping to keep connection alive		
				setInterval(function () { websocket.send('{"op":"ping"}') }, 30000);
				
				PullToRefresh.init({
					onRefresh() {
						init();
					},
					distMax: 100,
					distReload: 90,
					classPrefix: "ptr--"
				});
			};
			
			window.addEventListener("load", init, false);
		</script>
	</body>
</html>
